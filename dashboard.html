<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashbboard - SIPNOTUL</title>
    <link rel="stylesheet" href="src/styles.css?v=2">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- 
        ============================================
        SITE HEADER
        ============================================
        Sticky header with navigation and user menu
    -->
    <header class="site-header">
        <div class="container header-inner">
            <div class="header-left">
                <!-- Logo -->
                <a href="index.html" class="logo" style="color: var(--primary);">
                    <img src="./assets/logo.png" alt="SIPNOTUL Logo">
                    <span>SIPNOTUL</span>
                </a>
                <!-- Main navigation -->
                <nav class="main-nav">
                    <a href="dashboard.html" class="active">Dashboard</a>
                    <a href="manage.html">Kelola Notulen</a>
                </nav>
            </div>
            <div class="header-controls">
                <!-- New note button -->
                <button class="btn btn-primary btn-sm" id="newNoteBtn">+ Buat Notulen</button>
                <!-- User menu -->
                <div class="user-menu">
                    <button class="btn btn-secondary btn-sm" id="userMenuBtn">
                        <span id="userName">User</span>
                    </button>
                    <div class="dropdown-menu">
                        <a href="account.html">‚öôÔ∏è Pengaturan</a>
                        <button id="logoutBtn">üö™ Keluar</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 
        ============================================
        MAIN CONTENT
        ============================================
        Dashboard with stats, recent notes, and quick actions
    -->
    <main class="container" style="padding-top: 2rem; padding-bottom: 2rem;">
        
        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card card">
                <h4>Total Notulen</h4>
                <div class="stat-value" id="totalNotes">0</div>
            </div>
            <div class="stat-card card">
                <h4>Rapat Minggu Ini</h4>
                <div class="stat-value" id="weeklyMeetings">0</div>
            </div>
            <div class="stat-card card">
                <h4>Rapat Mendatang</h4>
                <div class="stat-value" id="pendingTasks">0</div>
            </div>
        </div>

        <!-- Recent Notes Section -->
        <section class="card" style="margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2>Notulen Terbaru</h2>
                <a href="manage.html" class="btn btn-secondary btn-sm">Lihat Semua</a>
            </div>
            <div id="recentNotes" class="notes-grid">
                <!-- Notes will be inserted here by JavaScript -->
            </div>
        </section>

        <!-- Quick Actions Section -->
        <section class="card" style="margin-bottom: 2rem;">
            <h2 style="margin-bottom: 1.5rem;">Aksi Cepat</h2>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <button class="btn btn-primary" id="newNoteBtn2">+ Buat Notulen Baru</button>
                <button class="btn btn-secondary" id="viewAllBtn">üìã Lihat Semua Notulen</button>
            </div>
        </section>

        <!-- Upcoming Meetings Section -->
        <section class="card">
            <h2 style="margin-bottom: 1.5rem; display:flex; justify-content:space-between; align-items:center;">
                <span>Rapat Mendatang</span>
                <button class="btn btn-primary btn-sm" id="addMeetingBtn">+ Tambah Rapat</button>
            </h2>

            <!-- Calendar Preview -->
            <div id="calendarPreview" style="margin-bottom: 1.5rem;">
                <div style="background: var(--gray-50); padding: 1rem; border-radius: var(--radius-md);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <button class="btn btn-secondary btn-sm" id="prevMonthBtn">‚Üê Bulan Sebelumnya</button>
                        <div id="currentMonthYear" style="font-weight: 600; color: var(--primary);"></div>
                        <button class="btn btn-secondary btn-sm" id="nextMonthBtn">Bulan Berikutnya ‚Üí</button>
                    </div>
                    <div id="calendarGrid"></div>
                    <div style="margin-top: 1rem; font-size: 0.75rem; color: var(--text-muted); display: flex; gap: 1rem; justify-content: center;">
                        <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--primary); border-radius: 2px; margin-right: 4px;"></span>Hari Ini</span>
                        <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--success); border-radius: 2px; margin-right: 4px;"></span>Ada Rapat</span>
                    </div>
                </div>
            </div>

            <!-- Meetings List -->
            <div id="upcomingMeetings">
                <!-- Meetings will be inserted here by JavaScript -->
            </div>
        </section>

        <!-- Add Meeting Modal -->
        <div id="addMeetingModal" class="modal">
            <div class="modal-overlay" onclick="closeAddMeetingModal()"></div>
            <div class="modal-content">
                <button class="modal-close" onclick="closeAddMeetingModal()">&times;</button>
                <div class="modal-header">
                    <h2>Tambah Rapat Baru</h2>
                    <p>Jadwalkan rapat mendatang</p>
                </div>
                <div class="modal-body">
                    <form id="addMeetingForm">
                        <div class="form-group">
                            <label class="form-label" for="meetingTitle">Judul Rapat</label>
                            <input type="text" class="form-input" id="meetingTitle" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="meetingDate">Tanggal</label>
                                <input type="date" class="form-input" id="meetingDate" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="meetingTime">Waktu</label>
                                <input type="time" class="form-input" id="meetingTime" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="meetingLocation">Lokasi</label>
                            <input type="text" class="form-input" id="meetingLocation" placeholder="Contoh: GU 702" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="meetingDescription">Deskripsi (Opsional)</label>
                            <textarea class="form-input" id="meetingDescription" rows="3" placeholder="Agenda atau catatan rapat"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="meetingIsPublic" checked>
                                <span style="margin-left: 0.5rem;">Rapat Publik (Semua user dapat melihat)</span>
                            </label>
                        </div>
                        <div class="form-group" id="participantSelection" style="display: none;">
                            <label class="form-label">Undang Peserta</label>
                            <div id="userCheckboxes" style="max-height: 150px; overflow-y: auto; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius-md);">
                                <!-- User checkboxes will be inserted here -->
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">üíæ Simpan Rapat</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- View Meeting Details Modal -->
        <div id="viewMeetingModal" class="modal">
            <div class="modal-overlay" onclick="closeMeetingDetailsModal()"></div>
            <div class="modal-content">
                <button class="modal-close" onclick="closeMeetingDetailsModal()">&times;</button>
                <div class="modal-header">
                    <h2 id="meetingDetailTitle">Detail Rapat</h2>
                    <p id="meetingDetailDate"></p>
                </div>
                <div class="modal-body">
                    <div id="meetingDetailsContent">
                        <!-- Meeting details will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast container -->
    <div id="toasts" class="toasts"></div>

    <!-- 
        ============================================
        JAVASCRIPT
        ============================================
        Dashboard functionality
    -->
    <script type="module">
        import { requireAuth, getCurrentUser, logout, showToast } from './src/auth.js';
        import { getAllNotes, getNotesByAuthor, deleteNote, getAllMeetings, getMeetingsForUser, saveMeeting, deleteMeeting, getAllUsers } from './src/storage.js';
        
        // Calendar state
        let currentCalendarMonth = new Date().getMonth();
        let currentCalendarYear = new Date().getFullYear();

        // ============================================
        // CHECK AUTHENTICATION
        // ============================================
        // Redirect to home if not logged in
        if (!requireAuth()) {
            // Will redirect, no need to continue
        }

        // Get current user
        const user = getCurrentUser();
        console.log('[DASHBOARD] User:', user.name);

        // Update user name in header
        document.getElementById('userName').textContent = user.name;

        // ============================================
        // UPDATE STATISTICS
        // ============================================
        function updateStats() {
            const userNotes = getNotesByAuthor(user.id);
            const now = new Date();
            const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
            
            // Calculate stats
            const stats = {
                total: userNotes.length,
                thisWeek: userNotes.filter(n => new Date(n.createdAt) >= weekStart).length,
                pending: userNotes.filter(n => n.followUp && !n.followUpCompleted).length
            };
            
            // Update DOM
            document.getElementById('totalNotes').textContent = stats.total;
            document.getElementById('weeklyMeetings').textContent = stats.thisWeek;
            document.getElementById('pendingTasks').textContent = stats.pending;
            
            console.log('[DASHBOARD] Stats updated:', stats);
        }

        // ============================================
        // RENDER RECENT NOTES
        // ============================================
        function renderRecentNotes() {
            const userNotes = getNotesByAuthor(user.id).slice(0, 6); // Get first 6 notes
            const container = document.getElementById('recentNotes');
            
            if (userNotes.length === 0) {
                container.innerHTML = '<p class="text-muted">Belum ada notulen. Buat notulen pertama Anda!</p>';
                return;
            }
            
            // Generate HTML for each note
            container.innerHTML = userNotes.map(note => `
                <div class="note-card card">
                    <div class="note-title">${escapeHtml(note.title)}</div>
                    <div class="note-meta">${formatDate(note.createdAt)}</div>
                    <div class="note-content">${escapeHtml((note.content || '').substring(0, 100))}...</div>
                    <div class="note-actions">
                        <button class="btn btn-secondary btn-sm" onclick="viewNote('${note.id}')">üëÅÔ∏è Lihat</button>
                        <button class="btn btn-secondary btn-sm" onclick="editNote('${note.id}')">‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="handleDeleteNote('${note.id}')">üóëÔ∏è Hapus</button>
                    </div>
                </div>
            `).join('');
            
            console.log('[DASHBOARD] Rendered', userNotes.length, 'recent notes');
        }

        // ============================================
        // RENDER CALENDAR PREVIEW
        // ============================================
        function renderCalendar() {
            const now = new Date();
            
            // Get all meetings for user
            const meetings = getMeetingsForUser(user.id);
            const meetingDates = new Set(meetings.map(m => m.meetingDate));
            
            // Get first day of month and number of days
            const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1).getDay();
            const daysInMonth = new Date(currentCalendarYear, currentCalendarMonth + 1, 0).getDate();
            
            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            const dayNames = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
            
            // Update month/year display
            document.getElementById('currentMonthYear').textContent = `${monthNames[currentCalendarMonth]} ${currentCalendarYear}`;
            
            let calendarHTML = `<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; text-align: center;">`;
            
            // Day headers
            dayNames.forEach(day => {
                calendarHTML += `<div style="font-size: 0.75rem; font-weight: 600; color: var(--text-muted); padding: 0.25rem;">${day}</div>`;
            });
            
            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += `<div></div>`;
            }
            
            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentCalendarYear}-${String(currentCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = day === now.getDate() && currentCalendarMonth === now.getMonth() && currentCalendarYear === now.getFullYear();
                const hasMeeting = meetingDates.has(dateStr);
                
                const bgColor = isToday ? 'var(--primary)' : hasMeeting ? 'var(--success)' : 'var(--white)';
                const textColor = (isToday || hasMeeting) ? 'white' : 'var(--text)';
                
                calendarHTML += `
                    <div 
                        onclick="${hasMeeting ? `showMeetingDetails('${dateStr}')` : ''}"
                        style="
                        padding: 0.5rem;
                        background: ${bgColor};
                        color: ${textColor};
                        border-radius: var(--radius-sm);
                        font-size: 0.875rem;
                        font-weight: ${hasMeeting ? '600' : '400'};
                        cursor: ${hasMeeting ? 'pointer' : 'default'};
                        border: 1px solid var(--border);
                        transition: transform 0.2s;
                    " ${hasMeeting ? 'onmouseover="this.style.transform=\'scale(1.1)\'" onmouseout="this.style.transform=\'scale(1)\'"' : ''}>${day}</div>
                `;
            }
            
            calendarHTML += `</div>`;
            
            document.getElementById('calendarGrid').innerHTML = calendarHTML;
        }

        // ============================================
        // RENDER UPCOMING MEETINGS
        // ============================================
        function renderUpcomingMeetings() {
            // Get meetings for current user
            const userMeetings = getMeetingsForUser(user.id)
                .filter(m => m.meetingDate && new Date(m.meetingDate) >= new Date().setHours(0,0,0,0))
                .sort((a, b) => new Date(a.meetingDate) - new Date(b.meetingDate))
                .slice(0, 10);
            
            const container = document.getElementById('upcomingMeetings');
            
            if (userMeetings.length === 0) {
                container.innerHTML = '<p class="text-muted">Tidak ada rapat mendatang</p>';
                return;
            }
            
            // Generate HTML for each meeting
            container.innerHTML = userMeetings.map(meeting => {
                const isMyMeeting = meeting.authorId === user.id;
                const isInvited = meeting.invitedUsers && meeting.invitedUsers.includes(user.id);
                return `
                <div style="display: flex; gap: 1rem; padding: 1rem; background: var(--gray-50); border-radius: var(--radius-md); margin-bottom: 0.5rem; border-left: 3px solid ${isMyMeeting ? 'var(--primary)' : 'var(--success)'};">
                    <div style="text-align: center; min-width: 60px;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${new Date(meeting.meetingDate).getDate()}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">${new Date(meeting.meetingDate).toLocaleString('id', {month: 'short'})}</div>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${escapeHtml(meeting.title)}</div>
                        <div style="font-size: 0.875rem; color: var(--text-muted);">
                            ${meeting.time || 'TBD'} - ${meeting.location || 'TBD'}
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">
                            ${isMyMeeting ? 'üë§ Rapat Anda' : isInvited ? 'üìß Diundang' : 'üë• Rapat Publik'}
                        </div>
                    </div>
                </div>
            `}).join('');
            
            console.log('[DASHBOARD] Rendered', userMeetings.length, 'upcoming meetings');
        } 

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Format date to Indonesian locale
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // ============================================
        // MODAL CONTROLS
        // ============================================
        window.closeAddMeetingModal = () => {
            document.getElementById('addMeetingModal').classList.remove('show');
        };

        window.closeMeetingDetailsModal = () => {
            document.getElementById('viewMeetingModal').classList.remove('show');
        };

        // ============================================
        // SHOW MEETING DETAILS
        // ============================================
        window.showMeetingDetails = (dateStr) => {
            // Get all meetings for this date that user can see
            const meetings = getMeetingsForUser(user.id).filter(m => m.meetingDate === dateStr);
            
            if (meetings.length === 0) return;
            
            // Format date
            const date = new Date(dateStr);
            const formattedDate = date.toLocaleDateString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('meetingDetailDate').textContent = formattedDate;
            
            // Generate HTML for all meetings on this date
            let detailsHTML = '';
            
            meetings.forEach((meeting, index) => {
                // Get author info
                const author = getAllNotes().find(n => n.authorId === meeting.authorId);
                const authorName = author ? getUserName(meeting.authorId) : 'Unknown';
                const isMyMeeting = meeting.authorId === user.id;
                
                detailsHTML += `
                    <div style="padding: 1rem; background: var(--gray-50); border-radius: var(--radius-md); margin-bottom: ${index < meetings.length - 1 ? '1rem' : '0'}; border-left: 3px solid ${isMyMeeting ? 'var(--primary)' : 'var(--success)'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                            <h3 style="margin: 0; color: var(--primary);">${escapeHtml(meeting.title)}</h3>
                            <span style="padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; background: ${isMyMeeting ? 'var(--primary)' : 'var(--success)'}; color: white;">
                                ${isMyMeeting ? 'üë§ Rapat Anda' : 'üë• Rapat Tim'}
                            </span>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-weight: 600; min-width: 100px;">‚è∞ Waktu:</span>
                                <span>${meeting.time || 'Belum ditentukan'}</span>
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-weight: 600; min-width: 100px;">üìç Lokasi:</span>
                                <span>${escapeHtml(meeting.location || 'Belum ditentukan')}</span>
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-weight: 600; min-width: 100px;">üë§ Dibuat oleh:</span>
                                <span>${escapeHtml(authorName)}</span>
                            </div>
                            
                            ${meeting.content && meeting.content !== `Rapat: ${meeting.title}` ? `
                            <div style="margin-top: 0.5rem; padding-top: 0.75rem; border-top: 1px solid var(--border);">
                                <span style="font-weight: 600;">üìù Deskripsi:</span>
                                <p style="margin: 0.5rem 0 0 0; color: var(--text-muted);">${escapeHtml(meeting.content)}</p>
                            </div>
                            ` : ''}
                            
                            ${meeting.attendees && meeting.attendees.length > 0 ? `
                            <div style="margin-top: 0.5rem; padding-top: 0.75rem; border-top: 1px solid var(--border);">
                                <span style="font-weight: 600;">üë• Peserta:</span>
                                <p style="margin: 0.5rem 0 0 0; color: var(--text-muted);">${meeting.attendees.join(', ')}</p>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary btn-sm" onclick="window.location.href='viewer.html?code=${meeting.id}'">üëÅÔ∏è Lihat Detail</button>
                            ${isMyMeeting ? `<button class="btn btn-secondary btn-sm" onclick="window.location.href='editor.html?id=${meeting.id}'">‚úèÔ∏è Edit</button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('meetingDetailTitle').textContent = meetings.length === 1 ? 'Detail Rapat' : `${meetings.length} Rapat`;
            document.getElementById('meetingDetailsContent').innerHTML = detailsHTML;
            document.getElementById('viewMeetingModal').classList.add('show');
        };

        // Helper function to get user name by ID
        function getUserName(userId) {
            // Try to find in demo users first
            const demoUsers = [
                { id: 2101, name: 'Demo User' },
                { id: 2102, name: 'Crist Garcia Pasaribu' },
                { id: 2103, name: 'Cahyati Lamona Sitohang' },
                { id: 2104, name: 'Fazri Rahman' },
                { id: 2105, name: 'Takanashi Hoshino' }
            ];
            
            const demoUser = demoUsers.find(u => u.id === userId);
            if (demoUser) return demoUser.name;
            
            // Try registered users
            try {
                const registered = JSON.parse(localStorage.getItem('sipenotul_registered_users') || '[]');
                const regUser = registered.find(u => u.id === userId);
                if (regUser) return regUser.name;
            } catch (e) {
                console.error('[DASHBOARD] Error getting user name:', e);
            }
            
            return 'Unknown User';
        }

        // ============================================
        // GLOBAL FUNCTIONS (for onclick handlers)
        // ============================================
        
        window.viewNote = (id) => window.location.href = `viewer.html?code=${id}`;
        window.editNote = (id) => window.location.href = `editor.html?id=${id}`;
        
        window.handleDeleteNote = (id) => {
            if (confirm('Apakah Anda yakin ingin menghapus notulen ini?')) {
                deleteNote(id);
                showToast('Notulen berhasil dihapus', 'success');
                updateStats();
                renderRecentNotes();
                renderCalendar();
                renderUpcomingMeetings();
            }
        };

        // ============================================
        // EVENT LISTENERS
        // ============================================
        
        // Add meeting button
        document.getElementById('addMeetingBtn').addEventListener('click', () => {
            document.getElementById('addMeetingModal').classList.add('show');
            // Set default date to today
            document.getElementById('meetingDate').valueAsDate = new Date();
            
            // Load user list for participant selection
            loadUserList();
        });

        // Public/Private toggle
        document.getElementById('meetingIsPublic').addEventListener('change', (e) => {
            const participantSelection = document.getElementById('participantSelection');
            participantSelection.style.display = e.target.checked ? 'none' : 'block';
        });

        // Month navigation
        document.getElementById('prevMonthBtn').addEventListener('click', () => {
            currentCalendarMonth--;
            if (currentCalendarMonth < 0) {
                currentCalendarMonth = 11;
                currentCalendarYear--;
            }
            renderCalendar();
        });

        document.getElementById('nextMonthBtn').addEventListener('click', () => {
            currentCalendarMonth++;
            if (currentCalendarMonth > 11) {
                currentCalendarMonth = 0;
                currentCalendarYear++;
            }
            renderCalendar();
        });

        // Load user list for participant selection
        function loadUserList() {
            const allUsers = getAllUsers();
            const container = document.getElementById('userCheckboxes');
            
            container.innerHTML = allUsers
                .filter(u => u.id !== user.id) // Exclude current user
                .map(u => `
                    <label style="display: block; padding: 0.5rem; cursor: pointer; border-radius: var(--radius-sm); transition: background 0.2s;" onmouseover="this.style.background='var(--gray-100)'" onmouseout="this.style.background='transparent'">
                        <input type="checkbox" name="invitedUsers" value="${u.id}" style="margin-right: 0.5rem;">
                        ${escapeHtml(u.name)} ${u.nim ? `(${u.nim})` : ''}
                    </label>
                `).join('');
        }

        // Add meeting form submission
        document.getElementById('addMeetingForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const title = document.getElementById('meetingTitle').value.trim();
            const date = document.getElementById('meetingDate').value;
            const time = document.getElementById('meetingTime').value;
            const location = document.getElementById('meetingLocation').value.trim();
            const description = document.getElementById('meetingDescription').value.trim();
            const isPublic = document.getElementById('meetingIsPublic').checked;
            
            // Get invited users if not public
            let invitedUsers = [];
            if (!isPublic) {
                const checkboxes = document.querySelectorAll('input[name="invitedUsers"]:checked');
                invitedUsers = Array.from(checkboxes).map(cb => parseInt(cb.value));
            }
            
            // Create new meeting
            const newMeeting = {
                title: title,
                meetingDate: date,
                time: time,
                location: location,
                content: description || `Rapat: ${title}`,
                authorId: user.id,
                isPublic: isPublic,
                invitedUsers: invitedUsers,
                type: 'meeting'
            };
            
            // Save to storage
            saveMeeting(newMeeting);
            
            showToast('Rapat berhasil ditambahkan!', 'success');
            
            // Reset form and close modal
            document.getElementById('addMeetingForm').reset();
            document.getElementById('meetingIsPublic').checked = true;
            document.getElementById('participantSelection').style.display = 'none';
            closeAddMeetingModal();
            
            // Refresh displays
            updateStats();
            renderCalendar();
            renderUpcomingMeetings();
        });
        
        // New note buttons
        document.getElementById('newNoteBtn').addEventListener('click', () => {
            window.location.href = 'editor.html';
        });
        
        document.getElementById('newNoteBtn2').addEventListener('click', () => {
            window.location.href = 'editor.html';
        });
        
        // View all button
        document.getElementById('viewAllBtn').addEventListener('click', () => {
            window.location.href = 'manage.html';
        });
        
        // Logout button
        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (confirm('Anda yakin ingin keluar?')) {
                logout();
            }
        });
        
        // User menu toggle
        document.getElementById('userMenuBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            document.querySelector('.user-menu').classList.toggle('open');
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.user-menu')) {
                document.querySelectorAll('.user-menu.open').forEach(menu => {
                    menu.classList.remove('open');
                });
            }
        });

        // ============================================
        // INITIALIZE
        // ============================================
        updateStats();
        renderRecentNotes();
        renderCalendar();
        renderUpcomingMeetings();
        
        console.log('[DASHBOARD] Initialized successfully');
    </script>
</body>
</html>
