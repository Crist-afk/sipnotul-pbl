<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SIPNOTUL</title>
    <link rel="stylesheet" href="src/styles.css?v=2">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- 
        ============================================
        SITE HEADER
        ============================================
        Sticky header with navigation and user menu
    -->
    <header class="site-header">
        <div class="container header-inner">
            <div class="header-left">
                <!-- Logo -->
                <a href="index.html" class="logo" style="color: var(--primary);">
                    <img src="./assets/logo.png" alt="SIPNOTUL Logo">
                    <span>SIPNOTUL</span>
                </a>
                <!-- Main navigation -->
                <nav class="main-nav">
                    <a href="dashboard.html" class="active">Dashboard</a>
                    <a href="manage.html">Kelola Notulen</a>
                </nav>
            </div>
            <div class="header-controls">
                <!-- New note button -->
                <button class="btn btn-primary btn-sm" id="newNoteBtn">+ Buat Notulen</button>
                <!-- User menu -->
                <div class="user-menu">
                    <button class="btn btn-secondary btn-sm" id="userMenuBtn">
                        <span id="userName">User</span>
                    </button>
                    <div class="dropdown-menu">
                        <a href="account.html">‚öôÔ∏è Pengaturan</a>
                        <button id="logoutBtn">üö™ Keluar</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 
        ============================================
        MAIN CONTENT
        ============================================
        Dashboard with stats, recent notes, and quick actions
    -->
    <main class="container" style="padding-top: 2rem; padding-bottom: 2rem;">
        
        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card card">
                <h4>Total Notulen</h4>
                <div class="stat-value" id="totalNotes">0</div>
            </div>
            <div class="stat-card card">
                <h4>Rapat Minggu Ini</h4>
                <div class="stat-value" id="weeklyMeetings">0</div>
            </div>
            <div class="stat-card card">
                <h4>Rapat Mendatang</h4>
                <div class="stat-value" id="pendingTasks">0</div>
            </div>
        </div>

        <!-- Recent Notes Section -->
        <section class="card" style="margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2>Notulen Terbaru</h2>
                <a href="manage.html" class="btn btn-secondary btn-sm">Lihat Semua</a>
            </div>
            <div id="recentNotes" class="notes-grid">
                <!-- Notes will be inserted here by JavaScript -->
            </div>
        </section>

        <!-- Quick Actions Section -->
        <section class="card" style="margin-bottom: 2rem;">
            <h2 style="margin-bottom: 1.5rem;">Aksi Cepat</h2>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <button class="btn btn-primary" id="newNoteBtn2">+ Buat Notulen Baru</button>
                <button class="btn btn-secondary" id="viewAllBtn">üìã Lihat Semua Notulen</button>
            </div>
        </section>

        <!-- Upcoming Meetings Section -->
        <section class="card">
            <h2 style="margin-bottom: 1.5rem; display:flex; justify-content:space-between; align-items:center;">
                <span>Rapat Mendatang</span>
                <button class="btn btn-primary btn-sm" id="addMeetingBtn">+ Tambah Rapat</button>
            </h2>

            <div id="upcomingMeetings">
                <!-- Meetings will be inserted here by JavaScript -->
            </div>
        </section>
        <!-- POPUP KALENDER TAMBAH RAPAT -->
         <div id="addMeetingModal" class="popup hidden">
            <div class="popup-box card">
                <h3>Tambah Rapat Baru</h3>
                
                <label>Judul Rapat</label>
                <input type="text" id="addTitle" class="input">
                
                <label>Tanggal Rapat</label>
                <input type="date" id="addDate" class="input">
                
                <label>Waktu Rapat</label>
                <input type="time" id="addTime" class="input">
                
                <label>Lokasi Rapat</label>
                <input type="text" id="addLocation" class="input">
                
                <div style="display:flex; justify-content:end; gap:1rem; margin-top:1rem;">
                    <button class="btn btn-secondary" id="cancelAddMeeting">Batal</button>
                    <button class="btn btn-primary" id="saveNewMeeting">Simpan</button>
                </div>
            </div>
        </div>
        
        <style>
        .popup {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: 1rem;
        }
        .popup-box {
            width: 100%;
            max-width: 450px;
            padding: 1.5rem;
            border-radius: 12px;
            background: white;
        }
        .hidden {
            display: none;
        }
        </style>
    </main>

    <!-- Toast container -->
    <div id="toasts" class="toasts"></div>

    <!-- 
        ============================================
        JAVASCRIPT
        ============================================
        Dashboard functionality
    -->
    <script type="module">
        import { requireAuth, getCurrentUser, logout, showToast } from './src/auth.js';
        import { getAllNotes, getNotesByAuthor, deleteNote } from './src/storage.js';

        // ============================================
        // CHECK AUTHENTICATION
        // ============================================
        // Redirect to home if not logged in
        if (!requireAuth()) {
            // Will redirect, no need to continue
        }

        // Get current user
        const user = getCurrentUser();
        console.log('[DASHBOARD] User:', user.name);

        // Update user name in header
        document.getElementById('userName').textContent = user.name;

        // ============================================
        // UPDATE STATISTICS
        // ============================================
        function updateStats() {
            const userNotes = getNotesByAuthor(user.id);
            const now = new Date();
            const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
            
            // Calculate stats
            const stats = {
                total: userNotes.length,
                thisWeek: userNotes.filter(n => new Date(n.createdAt) >= weekStart).length,
                pending: userNotes.filter(n => n.followUp && !n.followUpCompleted).length
            };
            
            // Update DOM
            document.getElementById('totalNotes').textContent = stats.total;
            document.getElementById('weeklyMeetings').textContent = stats.thisWeek;
            document.getElementById('upcomingMeetings').textContent = stats.upcoming;
            
            console.log('[DASHBOARD] Stats updated:', stats);
        }

        // ============================================
        // RENDER RECENT NOTES
        // ============================================
        function renderRecentNotes() {
            const userNotes = getNotesByAuthor(user.id).slice(0, 6); // Get first 6 notes
            const container = document.getElementById('recentNotes');
            
            if (userNotes.length === 0) {
                container.innerHTML = '<p class="text-muted">Belum ada notulen. Buat notulen pertama Anda!</p>';
                return;
            }
            
            // Generate HTML for each note
            container.innerHTML = userNotes.map(note => `
                <div class="note-card card">
                    <div class="note-title">${escapeHtml(note.title)}</div>
                    <div class="note-meta">${formatDate(note.createdAt)}</div>
                    <div class="note-content">${escapeHtml((note.content || '').substring(0, 100))}...</div>
                    <div class="note-actions">
                        <button class="btn btn-secondary btn-sm" onclick="viewNote('${note.id}')">üëÅÔ∏è Lihat</button>
                        <button class="btn btn-secondary btn-sm" onclick="editNote('${note.id}')">‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="handleDeleteNote('${note.id}')">üóëÔ∏è Hapus</button>
                    </div>
                </div>
            `).join('');
            
            console.log('[DASHBOARD] Rendered', userNotes.length, 'recent notes');
        }

        // ============================================
        // RENDER UPCOMING MEETINGS
        // ============================================
        function renderUpcomingMeetings() {
            const notes = getAllNotes()
                .filter(n => n.meetingDate && new Date(n.meetingDate) > new Date())
                .sort((a, b) => new Date(a.meetingDate) - new Date(b.meetingDate))
                .slice(0, 5);
            
            const container = document.getElementById('upcomingMeetings');
            
            if (notes.length === 0) {
                container.innerHTML = '<p class="text-muted">Tidak ada rapat mendatang</p>';
                return;
            }
            
            // Generate HTML for each meeting
            container.innerHTML = notes.map(note => `
                <div style="display: flex; gap: 1rem; padding: 1rem; background: var(--gray-50); border-radius: var(--radius-md); margin-bottom: 0.5rem;">
                    <div style="text-align: center; min-width: 60px;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${new Date(note.meetingDate).getDate()}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">${new Date(note.meetingDate).toLocaleString('id', {month: 'short'})}</div>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${escapeHtml(note.title)}</div>
                        <div style="font-size: 0.875rem; color: var(--text-muted);">${note.time || 'TBD'} - ${note.location || 'TBD'}</div>
                    </div>
                </div>
            `).join('');
            
            console.log('[DASHBOARD] Rendered', notes.length, 'upcoming meetings');
            // OPEN ADD MEETING POPUP
            document.getElementById("addMeetingBtn").addEventListener("click", () => {
                document.getElementById("addMeetingModal").classList.remove("hidden");
            });

            // CLOSE POPUP
            document.getElementById("cancelAddMeeting").addEventListener("click", () => {
                document.getElementById("addMeetingModal").classList.add("hidden");
            });

            // SAVE NEW MEETING
            document.getElementById("saveNewMeeting").addEventListener("click", () => {
                const title = document.getElementById("addTitle").value;
                const date = document.getElementById("addDate").value;
                const time = document.getElementById("addTime").value;
                const location = document.getElementById("addLocation").value;

                if (!title || !date || !time) {
                    showToast("Lengkapi semua data rapat!", "danger");
                    return;
                }

                const newMeeting = {
                    id: "note-" + Date.now(),
                    title,
                    meetingDate: date,
                    time,
                    location,
                    content: "",
                    createdAt: new Date().toISOString(),
                    authorId: getCurrentUser().id
                };

                const notes = getAllNotes();
                notes.push(newMeeting);
                localStorage.setItem("notes", JSON.stringify(notes));

                showToast("Rapat baru berhasil ditambahkan!", "success");

                renderUpcomingMeetings();
                document.getElementById("addMeetingModal").classList.add("hidden");

                document.getElementById("addTitle").value = "";
                document.getElementById("addDate").value = "";
                document.getElementById("addTime").value = "";
                document.getElementById("addLocation").value = "";
        });
        } 

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Format date to Indonesian locale
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // ============================================
        // GLOBAL FUNCTIONS (for onclick handlers)
        // ============================================
        
        window.viewNote = (id) => window.location.href = `viewer.html?code=${id}`;
        window.editNote = (id) => window.location.href = `editor.html?id=${id}`;
        
        window.handleDeleteNote = (id) => {
            if (confirm('Apakah Anda yakin ingin menghapus notulen ini?')) {
                deleteNote(id);
                showToast('Notulen berhasil dihapus', 'success');
                updateStats();
                renderRecentNotes();
                renderUpcomingMeetings();
            }
        };

        // ============================================
        // EVENT LISTENERS
        // ============================================
        
        // New note buttons
        document.getElementById('newNoteBtn').addEventListener('click', () => {
            window.location.href = 'editor.html';
        });
        
        document.getElementById('newNoteBtn2').addEventListener('click', () => {
            window.location.href = 'editor.html';
        });
        
        // View all button
        document.getElementById('viewAllBtn').addEventListener('click', () => {
            window.location.href = 'manage.html';
        });
        
        // Logout button
        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (confirm('Anda yakin ingin keluar?')) {
                logout();
            }
        });
        
        // User menu toggle
        document.getElementById('userMenuBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            document.querySelector('.user-menu').classList.toggle('open');
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.user-menu')) {
                document.querySelectorAll('.user-menu.open').forEach(menu => {
                    menu.classList.remove('open');
                });
            }
        });

        // ============================================
        // INITIALIZE
        // ============================================
        updateStats();
        renderRecentNotes();
        renderUpcomingMeetings();
        
        console.log('[DASHBOARD] Initialized successfully');
    </script>
</body>
</html>
