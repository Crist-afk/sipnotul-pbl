<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Notulen - SIPNOTUL</title>
    <link rel="stylesheet" href="src/styles.css?v=2">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Responsive Design untuk Editor Page */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            overflow-x: hidden;
        }

        /* Header Responsive */
        .site-header {
            padding: 1rem;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
            font-size: 1.1rem;
            text-decoration: none;
            color: var(--primary);
        }

        .logo img {
            height: 40px;
            width: auto;
        }

        .header-controls {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .save-status {
            font-size: 0.8rem;
            color: #6b7280;
            padding: 0.5rem 0.75rem;
            white-space: nowrap;
        }

        /* Main Content */
        .container {
            width: 100%;
            max-width: 1200px;
            padding: 0 1rem;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea.form-input {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-row .form-group {
            margin-bottom: 0;
            flex: 1;
        }

        /* Section Styles */
        .form-section {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .form-section h3 {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #333;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e5e7eb;
        }

        .btn-back {
            background: #e5e7eb;
            color: #333;
        }

        .btn-back:hover:not(:disabled) {
            background: #d1d5db;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        /* Attendees Section */
        .attendees-input-row {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .attendees-input-row .form-group {
            flex: 1;
            min-width: 200px;
            margin-bottom: 0;
        }

        .attendees-input-row .btn {
            flex-shrink: 0;
        }

        .attendees-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 6px;
            min-height: 50px;
            align-content: flex-start;
        }

        .attendee-badge {
            background: white;
            border: 1px solid #d1d5db;
            padding: 0.5rem 0.75rem;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            animation: slideIn 0.2s ease;
        }

        .attendee-badge span:last-child {
            cursor: pointer;
            color: #dc2626;
            font-weight: bold;
            margin-left: 0.5rem;
            font-size: 1rem;
            line-height: 1;
        }

        .attendee-badge span:last-child:hover {
            color: #991b1b;
        }

        .empty-attendees {
            color: #6b7280;
            font-size: 0.875rem;
        }

        @keyframes slideIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Checkbox */
        input[type="checkbox"] {
            cursor: pointer;
            width: 1.1rem;
            height: 1.1rem;
        }

        label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        /* Toast Container */
        .toasts {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .toast {
            padding: 1rem 1.5rem;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            animation: slideIn 0.3s ease;
            max-width: 90vw;
        }

        .toast.success {
            background-color: #10b981;
        }

        .toast.error {
            background-color: #ef4444;
        }

        .toast.info {
            background-color: #3b82f6;
        }

        /* ========================================= */
        /* TABLET (768px - 1024px)                  */
        /* ========================================= */
        @media (min-width: 768px) {
            .site-header {
                padding: 1.5rem 2rem;
            }

            .header-inner {
                padding: 0 2rem;
                gap: 1rem;
            }

            .logo {
                font-size: 1.2rem;
            }

            .logo img {
                height: 45px;
            }

            .header-controls {
                gap: 1rem;
            }

            .save-status {
                font-size: 0.875rem;
            }

            .container {
                padding: 0 2rem;
                padding-top: 2rem;
                padding-bottom: 2rem;
            }

            .card {
                max-width: 950px;
                margin: 0 auto;
                padding: 2rem;
            }

            .form-row {
                flex-direction: row;
            }

            .form-row .form-group {
                flex: 1;
            }

            .attendees-input-row {
                flex-wrap: nowrap;
            }

            .attendees-input-row .form-group {
                min-width: auto;
                flex: 1;
            }

            .form-section h3 {
                font-size: 1.2rem;
            }
        }

        /* ========================================= */
        /* DESKTOP (1024px+)                        */
        /* ========================================= */
        @media (min-width: 1024px) {
            .site-header {
                padding: 1.5rem 2rem;
            }

            .header-inner {
                max-width: 1200px;
                padding: 0;
            }

            .container {
                max-width: 1000px;
            }

            .card {
                max-width: 950px;
                padding: 2.5rem;
            }

            .header-controls {
                gap: 1.5rem;
            }

            .form-row {
                flex-direction: row;
                gap: 1.5rem;
            }

            .form-section h3 {
                font-size: 1.3rem;
            }
        }

        /* ========================================= */
        /* ULTRA-WIDE (1440px+)                     */
        /* ========================================= */
        @media (min-width: 1440px) {
            .container {
                max-width: 1100px;
            }

            .card {
                max-width: 1050px;
            }
        }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="header-inner">
            <a href="dashboard.html" class="logo">
                <img src="./assets/logo.png" alt="SIPNOTUL Logo">
                <span>SIPNOTUL</span>
            </a>
            <div class="header-controls">
                <span id="saveStatus" class="save-status">Belum disimpan</span>
                <button class="btn btn-secondary btn-sm" id="shareBtn" title="Bagikan notulen">üîó Bagikan</button>
                <a href="dashboard.html" class="btn btn-back btn-sm" title="Kembali ke Dashboard">‚Üê Kembali</a>
                <button type="button" class="btn btn-primary btn-sm" id="saveBtn">üíæ Simpan</button>
            </div>
        </div>
    </header>

    <main class="container" style="padding-top: 1.5rem; padding-bottom: 2rem;">
        <div class="card">
            <h2 id="editorTitle" style="margin-bottom: 2rem; font-size: 1.75rem;">Notulen Baru</h2>
            
            <form id="noteForm">
                <input type="hidden" id="idNotes" name="idNotes">

                <!-- Informasi Rapat -->
                <div class="form-section">
                    <h3>Informasi Rapat</h3>
                    
                    <div class="form-group">
                        <label class="form-label" for="title">Judul Rapat *</label>
                        <input type="text" class="form-input" id="title" name="title" placeholder="Masukkan judul rapat" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="date">Tanggal *</label>
                            <input type="date" class="form-input" id="date" name="meetingDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="time">Waktu</label>
                            <input type="time" class="form-input" id="time" name="time">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="location">Tempat</label>
                            <input type="text" class="form-input" id="location" name="location" placeholder="Lokasi rapat">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Kode Akses (4 Digit)</label>
                            <input type="text" class="form-input" id="accessCodeDisplay" readonly 
                                   style="background-color: #f3f4f6; font-weight: bold; text-align: center; letter-spacing: 3px;"
                                   placeholder="----">
                        </div>
                    </div>
                </div>

                <!-- Peserta Rapat -->
                <div class="form-section">
                    <h3>Peserta Rapat</h3>
                    
                    <div class="attendees-input-row">
                        <div class="form-group">
                            <label class="form-label" for="attendeeInput" style="margin-bottom: 0.5rem; display: block;">Nama Peserta / NIM</label>
                            <input type="text" class="form-input" id="attendeeInput" placeholder="Ketik nama lalu tekan Enter">
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm" id="addAttendeeBtn">Tambah</button>
                    </div>

                    <div id="attendeesList" class="attendees-list">
                        <span class="empty-attendees" id="emptyAttendeesMsg">Belum ada peserta ditambahkan.</span>
                    </div>
                </div>

                <!-- Konten Notulen -->
                <div class="form-section">
                    <h3>Konten Notulen</h3>

                    <div class="form-group">
                        <label class="form-label" for="discussion">Hasil Pembahasan *</label>
                        <textarea class="form-input" id="discussion" name="content" placeholder="Tulis hasil pembahasan rapat..." required></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="decisions">Keputusan</label>
                        <textarea class="form-input" id="decisions" name="decisions" placeholder="Tulis keputusan yang diambil..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="tasks">Tindak Lanjut</label>
                        <textarea class="form-input" id="tasks" name="followUp" placeholder="Tulis rencana tindak lanjut..."></textarea>
                    </div>
                </div>

                <!-- Pengaturan -->
                <div class="form-section" style="border-bottom: none;">
                    <h3>Pengaturan</h3>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="isPublic" name="isPublic" value="1">
                        <span>Dapat diakses publik dengan kode/tautan</span>
                    </label>
                </div>
            </form>
        </div>
    </main>

    <div id="toasts" class="toasts"></div>

    <script type="module">
        import { requireAuth, getCurrentUser, showToast } from './src/auth.js';
        
        // Cek Login
        if (!requireAuth()) {
            // Redirect handled automatically
        }

        const user = getCurrentUser();
        console.log("Logged in user:", user);

        // ==========================================
        // VARIABLE GLOBAL: PESERTA
        // ==========================================
        let attendeesData = []; 

        // ==========================================
        // 1. LOGIKA UI PESERTA (TAMBAH/HAPUS DI LAYAR)
        // ==========================================
        const attendeeInput = document.getElementById('attendeeInput');
        const addAttendeeBtn = document.getElementById('addAttendeeBtn');
        const attendeesList = document.getElementById('attendeesList');
        const emptyMsg = document.getElementById('emptyAttendeesMsg');

        // Fungsi Render List di Layar
        function renderAttendees() {
            attendeesList.innerHTML = '';
            
            if (attendeesData.length === 0) {
                attendeesList.appendChild(emptyMsg);
                emptyMsg.style.display = 'block';
                return;
            }

            emptyMsg.style.display = 'none';

            attendeesData.forEach((person, index) => {
                const badge = document.createElement('div');
                badge.className = 'attendee-badge';
                badge.innerHTML = `
                    <span>üë§ ${escapeHtml(person.name)}</span>
                    <span onclick="removeAttendee(${index})">√ó</span>
                `;
                attendeesList.appendChild(badge);
            });
        }

        // Fungsi Tambah ke Array
        function addAttendee() {
            const val = attendeeInput.value.trim();
            if (val) {
                attendeesData.push({ nim: '-', name: val });
                attendeeInput.value = '';
                renderAttendees();
            }
        }

        // Fungsi Hapus dari Array
        window.removeAttendee = (index) => {
            attendeesData.splice(index, 1);
            renderAttendees();
        };

        // Event Listener Tombol Tambah Peserta
        addAttendeeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            addAttendee();
        });

        attendeeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addAttendee();
            }
        });

        // ==========================================
        // 2. LOGIKA EDIT (LOAD DATA DARI DATABASE)
        // ==========================================
        const params = new URLSearchParams(window.location.search);
        const noteId = params.get('id');

        if (noteId) {
            document.getElementById('editorTitle').textContent = 'Edit Notulen';
            document.getElementById('idNotes').value = noteId;
            loadNoteData(noteId);
        }

        async function loadNoteData(id) {
            try {
                const response = await fetch(`php/get_note_detail.php?id=${id}`); 
                const data = await response.json();

                if (data.status === 'success') {
                    const note = data.data;
                    document.getElementById('title').value = note.title;
                    document.getElementById('date').value = note.meetingDate;
                    document.getElementById('time').value = note.time;
                    document.getElementById('location').value = note.location;
                    document.getElementById('accessCodeDisplay').value = note.accessCode || '-';
                    document.getElementById('discussion').value = note.content;
                    document.getElementById('decisions').value = note.decisions;
                    document.getElementById('tasks').value = note.followUp;
                    document.getElementById('isPublic').checked = (note.isPublic == 1);

                    if (note.attendeesList) {
                        attendeesData = note.attendeesList;
                        renderAttendees();
                    }
                } else {
                    showToast('Gagal memuat data notulen: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Terjadi kesalahan koneksi', 'error');
            }
        }

        // ==========================================
        // 3. LOGIKA SIMPAN (KIRIM KE DATABASE)
        // ==========================================
        document.getElementById('saveBtn').addEventListener('click', async () => {
            const saveBtn = document.getElementById('saveBtn');
            const statusSpan = document.getElementById('saveStatus');
            
            const title = document.getElementById('title').value;
            if (!title) {
                showToast('Judul rapat wajib diisi!', 'error');
                return;
            }

            const form = document.getElementById('noteForm');
            const formData = new FormData(form);

            formData.append('authorNim', user.nim || user.id);
            formData.append('attendees', JSON.stringify(attendeesData));

            saveBtn.disabled = true;
            saveBtn.textContent = '‚è≥ Menyimpan...';
            statusSpan.textContent = 'Menyimpan...';

            try {
                const response = await fetch('php/save_note.php', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showToast('Berhasil disimpan ke Database!', 'success');
                    statusSpan.textContent = 'Tersimpan';
                    
                    if (result.accessCode) {
                        document.getElementById('accessCodeDisplay').value = result.accessCode;
                    }

                    if (!noteId) {
                        setTimeout(() => {
                            window.location.href = 'dashboard.html';
                        }, 1500);
                    }
                } else {
                    throw new Error(result.message);
                }

            } catch (error) {
                console.error('Error:', error);
                showToast('Gagal menyimpan: ' + error.message, 'error');
                statusSpan.textContent = 'Gagal menyimpan';
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'üíæ Simpan';
            }
        });

        // ==========================================
        // 4. FITUR SHARE
        // ==========================================
        document.getElementById('shareBtn').addEventListener('click', () => {
            const currentId = document.getElementById('idNotes').value;
            if (currentId) {
                const url = `${location.origin}/viewer.html?code=${currentId}`;
                navigator.clipboard.writeText(url);
                showToast('Link tersalin!', 'success');
            } else {
                showToast('Simpan notulen dulu sebelum membagikan', 'info');
            }
        });

        // ==========================================
        // UTILITY
        // ==========================================
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>